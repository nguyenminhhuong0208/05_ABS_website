<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Trading Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script src="https://d3js.org/d3.v7.min.js"></script>
<style>
body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; color: #1f2937; margin:0; }
.header-link:hover { color:#e0d7f7; }
.tooltip { position: absolute; background: rgba(0,0,0,0.75); color: #fff; padding:6px 10px; border-radius:4px; font-size:13px; pointer-events:none; opacity:0; z-index:10; }
.sector-rect { fill:#f9fafb; stroke:#d1d5db; stroke-width:1px; rx:6; ry:6; }
.sector-label-bg { fill:#e5e7eb; stroke:#d1d5db; stroke-width:1px; }
.sector-text { fill:#374151; font-weight:bold; font-size:14px; }
</style>
</head>
<body class="min-h-screen">

<!-- Header -->
<header class="bg-purple-800 text-white shadow-lg py-4 px-6 fixed top-0 w-full z-50">
    <div class="container mx-auto flex justify-between items-center">
        <h1 class="text-3xl font-bold">Trading Dashboard</h1>
        <nav class="space-x-4 flex items-center">
            <a href="index.html" class="header-link">Trang chủ</a>
            <a href="dashboard.html" class="header-link font-bold">Dashboard</a>
            <a href="about-us.html" class="header-link">Về chúng tôi</a>
        </nav>
    </div>
</header>

<main class="container mx-auto p-6 pt-24 space-y-6">

    <!-- Chỉ số thị trường -->
    <section class="grid lg:grid-cols-3 gap-6">
        <div class="lg:col-span-2 bg-white rounded-xl shadow-lg p-6 flex flex-col justify-center">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Chỉ số VN</h2>
            <div id="index-bar-chart"></div>
            <div id="index-section" class="grid grid-cols-2 lg:grid-cols-4 gap-4 mt-4 text-center"></div>
        </div>

        <!-- Dòng tiền -->
        <div class="bg-white rounded-xl shadow-lg p-6 flex flex-col space-y-6">
            <h2 class="text-2xl font-bold text-gray-800">Dòng tiền</h2>
            <div id="market-summary-chart"></div>
            <div id="cash-flow-chart"></div>
        </div>
    </section>

    <!-- Heatmap -->
    <section class="bg-white rounded-xl shadow-lg p-6">
        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Heatmap cổ phiếu</h2>
        <div id="heatmap-container" style="width:100%; height:650px; position:relative;"></div>
    </section>

</main>

<footer class="bg-gray-800 text-white text-center py-4 mt-12 shadow-inner">
    <p class="text-sm">© 2024 Đội ngũ Môi giới. Tất cả quyền được bảo lưu.</p>
</footer>

<script>
// ---------- Cấu hình dữ liệu giả lập ----------
const stockFullNames = {
    "SHB":"Ngân hàng SHB","SSI":"Chứng khoán SSI","VIX":"Chứng khoán VIX","VPB":"Ngân hàng VPB",
    "VND":"Chứng khoán VNDIRECT","MBB":"Ngân hàng MBB","ACB":"Ngân hàng ACB","TCB":"Ngân hàng TCB",
    "HDB":"Ngân hàng HDB","EIB":"Ngân hàng EIB","TPB":"Ngân hàng TPB","VIB":"Ngân hàng VIB",
    "VCB":"Ngân hàng VCB","MSB":"Ngân hàng MSB","HCM":"Chứng khoán HCM","STB":"Ngân hàng STB",
    "DIG":"Đầu tư Xây dựng","PDR":"Bất động sản Phát Đạt","DXG":"Tập đoàn Đất Xanh","HDG":"Tập đoàn Hà Đô",
    "TCH":"Đầu tư Tài chính Hoàng Huy","NVL":"Tập đoàn No Va","KHG":"Khang Điền House","SCR":"Địa ốc Sài Gòn Thương Tín",
    "KBC":"Đô thị Kinh Bắc","LDG":"Đầu tư LDG","HDC":"Nhà Bà Rịa Vũng Tàu","VRE":"Vincom Retail",
    "HPG":"Tập đoàn Hòa Phát","NKG":"Thép Nam Kim","HSG":"Tập đoàn Hoa Sen","POM":"Thép Pomina","SMC":"SMC",
    "CII":"Đầu tư Hạ tầng CII","VCG":"Xuất nhập khẩu VCG","GEG":"Điện lực Gia Lai","VSC":"Container Việt Nam","LSS":"Mía đường Sơn La","FPT":"FPT"
};

const sectorsData = [
    { name:"Tài chính", stocks:["SHB","SSI","VIX","VPB","VND","MBB","ACB","TCB","HDB","EIB","TPB","VIB","VCB","HCM","MSB","STB"] },
    { name:"Bất động sản", stocks:["DIG","PDR","DXG","HDG","TCH","NVL","KHG","SCR","KBC","LDG","HDC","VRE"] },
    { name:"Vật liệu cơ bản", stocks:["HPG","NKG","HSG","POM","SMC"] },
    { name:"Công nghiệp", stocks:["CII","VCG","GEG","VSC","LSS","FPT"] }
];

function generateRandomData() {
    return sectorsData.map(sector=>{
        const children = sector.stocks.map(stock=>{
            const change = +(Math.random()*10-5).toFixed(2);
            const price = +(Math.random()*90000+10000).toFixed(0);
            const volume = Math.floor(Math.random()*9000000+100000);
            const full_name = stockFullNames[stock] || stock;
            return { name: stock, full_name, change, price, volume };
        });
        const sectorValue = children.reduce((sum,d)=>sum+d.volume,0);
        return { name: sector.name, value: sectorValue, children };
    });
}

// ---------- Heatmap ----------
const tooltip = d3.select("body").append("div").attr("class","tooltip");
const colorScale = d3.scaleLinear().domain([-5,0,5]).range(["#dc2626","#e5e7eb","#22c55e"]).clamp(true);

function drawHeatmap(data){
    const container = d3.select("#heatmap-container");
    const width = container.node().clientWidth;
    const height = container.node().clientHeight;
    container.select("svg").remove();

    const svg = container.append("svg")
        .attr("width","100%").attr("height","100%")
        .attr("viewBox",`0 0 ${width} ${height}`)
        .attr("preserveAspectRatio","xMidYMid meet");

    const root = d3.hierarchy({children:data}).sum(d=>d.volume||d.value).sort((a,b)=>b.value-b.value);
    const treemap = d3.treemap().size([width,height]).paddingOuter(6).paddingInner(2);
    treemap(root);

    const sectors = svg.selectAll(".sector-group").data(root.children).join("g")
        .attr("class","sector-group")
        .attr("transform",d=>`translate(${d.x0},${d.y0})`);
    sectors.append("rect").attr("class","sector-rect").attr("width",d=>d.x1-d.x0).attr("height",d=>d.y1-d.y0);
    sectors.append("rect").attr("class","sector-label-bg").attr("x",0).attr("y",0).attr("width",d=>d.x1-d.x0).attr("height",24);
    sectors.append("text").attr("class","sector-text").attr("x",12).attr("y",16).text(d=>d.data.name);

    root.children.forEach(sector=>{
        const innerRoot = d3.hierarchy({children:sector.data.children}).sum(d=>d.volume);
        const innerTreemap = d3.treemap().size([sector.x1-sector.x0, sector.y1-sector.y0-24]).padding(2);
        innerTreemap(innerRoot);

        const stocks = svg.selectAll(`.stock-${sector.data.name.replace(/\s/g,'-')}`)
            .data(innerRoot.leaves()).join("g")
            .attr("class",d=>`stock-${sector.data.name.replace(/\s/g,'-')}`)
            .attr("transform",d=>`translate(${sector.x0 + d.x0},${sector.y0 + 24 + d.y0})`);

        stocks.append("rect").attr("width",d=>d.x1-d.x0).attr("height",d=>d.y1-d.y0)
            .attr("fill",d=>colorScale(d.data.change)).attr("rx",3).attr("ry",3)
            .attr("stroke","#fff").attr("stroke-width",0.5)
            .on("mouseover",(event,d)=>tooltip.style("opacity",1).html(
                `<b>${d.data.full_name} (${d.data.name})</b><br>Giá: ${d.data.price} VND<br>Volume: ${d.data.volume.toLocaleString()}<br>Change: ${d.data.change>0?'+':''}${d.data.change}%`
            ))
            .on("mousemove",(event)=>tooltip.style("left",(event.pageX+10)+"px").style("top",(event.pageY-20)+"px"))
            .on("mouseout",()=>tooltip.style("opacity",0));

        stocks.append("text").attr("x",4).attr("y",14).text(d=>d.data.name)
            .attr("font-size",d=>Math.max(8,Math.min(14,(d.x1-d.x0)/4))).attr("fill","white")
            .attr("font-weight","bold").attr("pointer-events","none")
            .each(function(d){if(this.getComputedTextLength()>d.x1-d.x0-4)d3.select(this).remove();});
    });
}

let currentData = generateRandomData();
drawHeatmap(currentData);
setInterval(()=>{currentData = generateRandomData(); drawHeatmap(currentData);},10000);
window.addEventListener("resize",()=>drawHeatmap(currentData));

// ---------- ApexCharts & Indices ----------
const mockIndexData = [
    {name:'VN-Index', value:(1200+Math.random()*200).toFixed(2), change:(Math.random()*5-2.5).toFixed(2)},
    {name:'HNX-Index', value:(250+Math.random()*50).toFixed(2), change:(Math.random()*2-1).toFixed(2)},
    {name:'UPCOM-Index', value:(90+Math.random()*10).toFixed(2), change:(Math.random()*1-0.5).toFixed(2)},
    {name:'VN30', value:(1250+Math.random()*100).toFixed(2), change:(Math.random()*3-1.5).toFixed(2)}
];

function updateIndices(data){
    const idxSec = document.getElementById('index-section');
    idxSec.innerHTML = data.map(d=>{
        const cls = d.change>0?'text-green-500':'text-red-500';
        return `<div class="bg-gray-100 rounded-lg p-4 shadow-sm">
            <h3 class="text-lg font-semibold">${d.name}</h3>
            <p class="text-xl font-bold mt-1">${d.value}</p>
            <p class="text-sm ${cls}">${d.change>0?'+':''}${d.change}%</p>
        </div>`;
    }).join('');
}
setInterval(()=>updateIndices(mockIndexData),5000);
updateIndices(mockIndexData);

// Pie chart Số lượng CP Tăng/Giảm/Không đổi
const pieOptions = {
    series: [10, 5, 3],
    chart: { type:'pie', height:250 },
    labels:['Tăng','Giảm','Không đổi'],
    colors:['#22c55e','#dc2626','#9ca3af'],
    legend:{ position:'bottom' }
};
const pieChart = new ApexCharts(document.querySelector("#market-summary-chart"), pieOptions);
pieChart.render();

// Bar chart dòng tiền
const barOptions = {
    series:[{name:'Dòng tiền', data:[5000,3000,1000]}],
    chart:{ type:'bar', height:250 },
    plotOptions:{ bar:{ columnWidth:'50%', distributed:true } },
    dataLabels:{ enabled:false },
    legend:{ show:false },
    colors:['#22c55e','#dc2626','#9ca3af'],
    xaxis:{ categories:['Tăng','Giảm','Không đổi'], labels:{ style:{colors:['#22c55e','#dc2626','#9ca3af'],fontSize:'12px'} } },
    tooltip:{ y:{ formatter:(val)=>val+' Tỷ' } }
};
const barChart = new ApexCharts(document.querySelector("#cash-flow-chart"), barOptions);
barChart.render();

// VN Index bar chart
const vnIndexOptions = {
    series:[{name:'Chỉ số', data:mockIndexData.map(d=>+d.value)}],
    chart:{ type:'bar', height:250 },
    xaxis:{ categories:mockIndexData.map(d=>d.name) },
    colors:['#6366f1'],
    dataLabels:{ enabled:true, formatter:(val)=>val.toFixed(2) }
};
const vnIndexChart = new ApexCharts(document.querySelector("#index-bar-chart"), vnIndexOptions);
vnIndexChart.render();
</script>
</body>
</html>
